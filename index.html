<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SKYSEND Backoffice</title>
  <style>
    :root{
      /* SKYSEND Brand Palette */
      --bg:#f0f7ff;
      --primary:#0ea5e9;          /* Sky Blue */
      --primary-dark:#0284c7;    /* Deep Sky Blue */
      --card:#ffffff;
      --muted:#64748b;
      --border:#e2e8f0;
      --success:#16a34a;
      --danger:#dc2626;
      --radius:14px;
    }

    *{box-sizing:border-box}

    body{
      font-family:Segoe UI, Tahoma, sans-serif;
      background:linear-gradient(180deg,#eef1ff 0%, var(--bg) 200px);
      margin:0;
      color:#111827;
    }

    header{
      background:linear-gradient(135deg,var(--primary),#38bdf8);
      color:#fff;
      padding:16px 24px;
      box-shadow:0 4px 20px rgba(14,165,233,.35);
      position:sticky;
      top:0;
      z-index:10;
      display:flex;
      align-items:center;
      justify-content:space-between;
    }

    header h1{
      margin:0;
      font-size:22px;
      letter-spacing:.3px;
    }

    .container{padding:24px;max-width:1400px;margin:0 auto}

    /* KPI CARDS */
    .cards{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
      gap:20px;
      margin-bottom:24px;
    }

    .card{
      background:var(--card);
      border-radius:var(--radius);
      padding:20px;
      box-shadow:0 10px 25px rgba(0,0,0,.08);
      transition:transform .15s ease, box-shadow .15s ease;
      position:relative;
      overflow:hidden;
      cursor:pointer;
    }

    .card::after{
      content:"";
      position:absolute;
      inset:auto 0 0 0;
      height:4px;
      background:linear-gradient(90deg,var(--primary),#8f9cf5);
    }

    .card:hover{
      transform:translateY(-2px);
      box-shadow:0 16px 40px rgba(0,0,0,.12);
    }

    .card h2{
      margin:0;
      font-size:14px;
      color:var(--muted);
      text-transform:uppercase;
      letter-spacing:.08em;
    }

    .card p{
      font-size:32px;
      margin:10px 0 0;
      color:var(--primary);
      font-weight:700;
    }

    /* TOOLBAR */
    .toolbar{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-bottom:16px;
      align-items:center;
      background:var(--card);
      padding:14px;
      border-radius:var(--radius);
      box-shadow:0 6px 20px rgba(0,0,0,.08);
    }

    /* Make search box more visible */
    .search-input{
      flex:1;
      min-width:320px;
      font-size:16px;
      padding:12px 14px;
      border:2px solid var(--primary);
      box-shadow:0 0 0 4px rgba(14,165,233,.15);
    }

    .toolbar input,
    .toolbar select,
    .toolbar button{
      padding:10px 12px;
      border-radius:10px;
      border:1px solid var(--border);
      font-size:14px;
      outline:none;
      background:#fff;
      transition:border .15s ease, box-shadow .15s ease, transform .05s ease;
    }

    .toolbar input:focus,
    .toolbar select:focus{
      border-color:var(--primary);
      box-shadow:0 0 0 3px rgba(102,126,234,.2);
    }

    .toolbar button{
      background:var(--primary);
      color:#fff;
      border:none;
      cursor:pointer;
      font-weight:600;
    }

    .toolbar button:hover{
      background:var(--primary-dark);
    }

    .toolbar button:active{
      transform:scale(.97);
    }

    .toolbar button.secondary{
      background:#9ca3af;
    }

    .toolbar button.secondary:hover{
      background:#6b7280;
    }

    /* TABLE */
    table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      background:var(--card);
      border-radius:var(--radius);
      overflow:hidden;
      box-shadow:0 10px 25px rgba(0,0,0,.08);
      margin-top:0; /* header spacing handled by container now */
    }

    thead{
      background:#f9fafb;
    }

    th,td{
      padding:12px 14px;
      text-align:left;
      border-bottom:1px solid var(--border);
    }

    th{
      font-weight:600;
      cursor:pointer;
      user-select:none;
      position:sticky;
      top:0; /* stick to top of table container, not under the page header */
      background:#f9fafb;
      z-index:5;
    }

    th span{
      font-size:12px;
      color:var(--muted);
      margin-left:4px;
    }

    tbody tr:hover{
      background:#e0f2fe;
    }

    tr:nth-child(even){background:#f7f9ff}
    tr:nth-child(odd){background:#ffffff}

    /* FULL MATCH ROW */
    .full-match{
      background:#bae6fd !important;
      border-left:6px solid var(--primary);
    }


    /* HIGHLIGHT */
    .hl{background:#fde047;color:#111827;padding:0 2px;border-radius:4px}

    /* BADGES */
    .badge{
      padding:4px 12px;
      border-radius:999px;
      font-size:12px;
      font-weight:700;
      display:inline-block;
    }

    .status-in{background:#e8f5e9;color:var(--success)}
    .status-out{background:#ffebee;color:var(--danger)}

    /* AIRPORT COLORS */
    .aot-BKK{background:#e0f2fe}
    .aot-DMK{background:#f0f9ff}
    .aot-CNX{background:#ecfeff}
    .aot-HKT{background:#fff7ed}
    .aot-HDY{background:#f0fdf4}
    .aot-CEI{background:#eef2ff}

    /* FLOW BUTTON */
    td button{
      padding:6px 12px;
      border-radius:999px;
      border:none;
      background:#eef2ff;
      color:var(--primary);
      font-weight:600;
      cursor:pointer;
      transition:background .15s ease, transform .05s ease;
    }

    td button:hover{
      background:#dbe4ff;
    }

    td button:active{
      transform:scale(.95);
    }

    /* DIALOG */
    dialog{
      border:none;
      border-radius:var(--radius);
      padding:24px;
      box-shadow:0 20px 50px rgba(0,0,0,.3);
      max-width:420px;
      width:90%;
    }

    dialog h3{margin-top:0}

    dialog button{
      margin-top:10px;
      background:var(--primary);
      color:#fff;
      border:none;
      padding:10px 14px;
      border-radius:10px;
      cursor:pointer;
      font-weight:600;
    }

    dialog button:hover{
      background:var(--primary-dark);
    }

    /* USER BOX */
    .user-box{
      display:flex;
      align-items:center;
      gap:10px;
      background:rgba(255,255,255,.15);
      padding:6px 12px;
      border-radius:999px;
      backdrop-filter:blur(6px);
    }

    .avatar{
      width:36px;
      height:36px;
      border-radius:50%;
      background:#fff;
      color:var(--primary);
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:800;
    }

    .user-info{line-height:1.1}
    .user-name{font-size:13px;font-weight:700}
    .user-role{font-size:11px;opacity:.9}

    @media (max-width: 768px){
      th{top:120px}
      .card p{font-size:26px}
    }

    .table-wrap{
      overflow:auto;
      max-height:70vh;
      position:relative; /* create sticky context for table header */
    }
      .card p{font-size:26px}
    }
  </style>
</head>
<body>

<header>
  <h1>‚úàÔ∏è SKYSEND Backoffice Dashboard</h1>
  <div class="user-box">
    <div class="avatar">A</div>
    <div class="user-info">
      <div class="user-name">Admin Operator</div>
      <div class="user-role">System Control</div>
    </div>
  </div>
</header>

<div class="container">
  <div class="cards">
    <div class="card" onclick="quickFilter('')"><h2>‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h2><p id="sumAll">0</p></div>
    <div class="card" onclick="quickFilter('‡∏≠‡∏¢‡∏π‡πà‡∏Ñ‡∏•‡∏±‡∏á')"><h2>‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏Ñ‡∏•‡∏±‡∏á</h2><p id="sumIn">0</p></div>
    <div class="card" onclick="quickFilter('‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß')"><h2>‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß</h2><p id="sumOut">0</p></div>
  </div>

  <div class="toolbar">
    <input id="searchInput" class="search-input" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ Tracking / ‡∏ä‡∏∑‡πà‡∏≠ / ‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà / ‡πÄ‡∏ö‡∏≠‡∏£‡πå" />
    <input type="date" id="filterDate" />
    <select id="filterAOT">
      <option value="">‡∏ó‡∏∏‡∏Å‡∏™‡∏ô‡∏≤‡∏°‡∏ö‡∏¥‡∏ô</option>
      <option value="BKK">‡∏™‡∏∏‡∏ß‡∏£‡∏£‡∏ì‡∏†‡∏π‡∏°‡∏¥ (BKK)</option>
      <option value="DMK">‡∏î‡∏≠‡∏ô‡πÄ‡∏°‡∏∑‡∏≠‡∏á (DMK)</option>
      <option value="CNX">‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà (CNX)</option>
      <option value="HKT">‡∏†‡∏π‡πÄ‡∏Å‡πá‡∏ï (HKT)</option>
      <option value="HDY">‡∏´‡∏≤‡∏î‡πÉ‡∏´‡∏ç‡πà (HDY)</option>
      <option value="CEI">‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡∏£‡∏≤‡∏¢ (CEI)</option>
    </select>
    <select id="filterStatus">
      <option value="">‡∏ó‡∏∏‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</option>
      <option value="‡∏≠‡∏¢‡∏π‡πà‡∏Ñ‡∏•‡∏±‡∏á">‡∏≠‡∏¢‡∏π‡πà‡∏Ñ‡∏•‡∏±‡∏á</option>
      <option value="‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß">‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß</option>
    </select>

    <button onclick="exportCSV()">üìÑ Export CSV</button>
    <button class="secondary" onclick="exportPDF()">üì¶ Export PDF ‡∏ï‡∏≤‡∏°‡∏™‡∏ô‡∏≤‡∏°‡∏ö‡∏¥‡∏ô</button>
    <button class="secondary" onclick="refreshPage()">üîÑ Refresh</button>
  </div>

  <div class="table-wrap"><table>
    <thead>
      <tr>
        <th onclick="sortBy('track')">Tracking<span id="s-track"></span></th>
        <th onclick="sortBy('sentAt')">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏∞‡∏ö‡∏ö<span id="s-sentAt"></span></th>
        <th onclick="sortBy('aot')">‡∏™‡∏ô‡∏≤‡∏°‡∏ö‡∏¥‡∏ô<span id="s-aot"></span></th>
        <th onclick="sortBy('sender')">‡∏ú‡∏π‡πâ‡∏™‡πà‡∏á<span id="s-sender"></span></th>
        <th onclick="sortBy('address')">‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á<span id="s-address"></span></th>
        <th onclick="sortBy('senderPhone')">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏ú‡∏π‡πâ‡∏™‡πà‡∏á<span id="s-senderPhone"></span></th>
        <th onclick="sortBy('weight')">‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å<span id="s-weight"></span></th>
        <th onclick="sortBy('status')">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞<span id="s-status"></span></th>
        <th>Flow</th>
      </tr>
    </thead>
    <tbody id="parcelTable"></tbody>
  </table></div>
</div>

<dialog id="timelineDialog"></dialog>

<script>
// =========================
// GLOBAL STATE
// =========================
const parcels = [];
const AOTS = ['BKK','DMK','CNX','HKT','HDY','CEI'];

let sortState = { key: 'sentAt', asc: false };
let _initialSortDone = false;

// =========================
// MASTER DATA
// =========================
const thaiFirstNames = ['‡∏ò‡∏ô‡∏û‡∏•','‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏ô‡∏Å','‡∏™‡∏°‡∏®‡∏±‡∏Å‡∏î‡∏¥‡πå','‡∏Å‡∏≤‡∏ô‡∏ï‡πå‡∏ä‡∏ô‡∏Å','‡∏ß‡∏£‡∏û‡∏•','‡∏ä‡∏•‡∏ò‡∏¥‡∏ä‡∏≤','‡∏≠‡∏†‡∏¥‡∏ä‡∏≤‡∏ï‡∏¥','‡∏•‡∏•‡∏¥‡∏ï‡∏≤','‡∏õ‡∏£‡∏µ‡∏ä‡∏≤','‡∏ò‡∏±‡∏ç‡∏ç‡∏≤','‡∏™‡∏∏‡∏û‡∏à‡∏ô‡πå','‡∏≠‡∏£‡∏≠‡∏ô‡∏á‡∏Ñ‡πå','‡∏Å‡∏¥‡∏ï‡∏ï‡∏¥‡∏û‡∏á‡∏©‡πå','‡∏®‡∏¥‡∏£‡∏¥‡∏û‡∏£','‡∏°‡∏ô‡∏±‡∏™','‡∏ß‡∏£‡∏≤‡∏†‡∏£‡∏ì‡πå','‡∏≠‡∏ô‡∏∏‡∏ä‡∏≤','‡∏û‡∏±‡∏ä‡∏£‡∏µ','‡∏ò‡∏µ‡∏£‡∏û‡∏á‡∏©‡πå','‡∏Å‡∏°‡∏•‡∏ä‡∏ô‡∏Å','‡∏™‡∏±‡∏ô‡∏ï‡∏¥','‡∏õ‡∏ß‡∏µ‡∏ì‡∏≤','‡∏≠‡∏≥‡∏ô‡∏≤‡∏à','‡∏ô‡∏§‡∏°‡∏•','‡∏™‡∏∏‡∏ä‡∏≤‡∏ï‡∏¥','‡∏£‡∏±‡∏ï‡∏ô‡∏≤','‡πÑ‡∏û‡∏®‡∏≤‡∏•','‡πÄ‡∏ö‡∏ç‡∏à‡∏°‡∏≤‡∏®','‡∏ì‡∏±‡∏ê‡∏û‡∏•','‡∏õ‡∏ì‡∏¥‡∏ò‡∏≤‡∏ô','‡∏à‡∏¥‡∏£‡∏≤‡∏†‡∏£‡∏ì‡πå','‡∏ß‡∏≤‡∏™‡∏ô‡∏≤','‡πÄ‡∏î‡∏ä‡∏≤‡∏ò‡∏£','‡∏≠‡∏±‡∏à‡∏â‡∏£‡∏≤','‡∏û‡∏¥‡∏ä‡∏¥‡∏ï','‡∏†‡∏±‡∏ó‡∏£‡∏ß‡∏î‡∏µ','‡∏ä‡∏≤‡∏ç‡∏ä‡∏±‡∏¢','‡∏ì‡∏±‡∏ê‡∏Å‡∏≤‡∏ô‡∏ï‡πå','‡∏Å‡∏∏‡∏•‡∏ò‡∏¥‡∏î‡∏≤','‡∏ß‡∏∏‡∏í‡∏¥‡∏ä‡∏±‡∏¢','‡∏®‡∏®‡∏¥‡∏ò‡∏£','‡∏ò‡∏ß‡∏±‡∏ä‡∏ä‡∏±‡∏¢','‡∏õ‡∏£‡∏µ‡∏¢‡∏≤‡∏ô‡∏∏‡∏ä','‡∏à‡∏≤‡∏£‡∏∏‡∏ß‡∏£‡∏£‡∏ì','‡∏õ‡∏Å‡∏£‡∏ì‡πå','‡∏≠‡∏¥‡∏™‡∏£‡∏µ‡∏¢‡πå','‡∏ò‡∏µ‡∏£‡∏®‡∏±‡∏Å‡∏î‡∏¥‡πå','‡∏î‡∏ß‡∏á‡πÉ‡∏à','‡∏®‡∏∏‡∏†‡∏ä‡∏±‡∏¢','‡∏Ç‡∏ß‡∏±‡∏ç‡∏§‡∏î‡∏µ'];

const thaiLastNames = ['‡∏®‡∏£‡∏µ‡∏ä‡∏±‡∏¢','‡∏ß‡∏±‡∏í‡∏ô‡∏≤','‡∏ö‡∏∏‡∏ç‡∏°‡∏≤','‡∏û‡∏£‡∏´‡∏°‡∏°‡∏≤','‡∏≠‡∏¥‡∏ô‡∏ó‡∏£‡πå‡∏ó‡∏≠‡∏á','‡∏°‡∏ì‡∏µ‡∏£‡∏±‡∏ï‡∏ô‡πå','‡πÅ‡∏Å‡πâ‡∏ß‡∏Ñ‡∏≥','‡∏™‡∏≤‡∏¢‡∏ó‡∏≠‡∏á','‡∏Ñ‡∏≥‡∏î‡∏µ','‡∏™‡∏∏‡∏Ç‡πÉ‡∏à','‡πÅ‡∏™‡∏ô‡∏î‡∏µ','‡πÉ‡∏à‡∏ö‡∏∏‡∏ç','‡∏ß‡∏á‡∏®‡πå‡∏ä‡∏±‡∏¢','‡πÅ‡∏Å‡πâ‡∏ß‡πÉ‡∏™','‡∏£‡∏∏‡πà‡∏á‡πÄ‡∏£‡∏∑‡∏≠‡∏á','‡∏û‡∏π‡∏•‡∏ú‡∏•','‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå‡∏î‡∏µ','‡πÅ‡∏î‡∏á‡∏î‡∏µ','‡πÅ‡∏™‡∏á‡∏ó‡∏≠‡∏á','‡∏ß‡∏¥‡πÄ‡∏®‡∏©','‡∏™‡∏∏‡∏Ç‡∏™‡∏ö‡∏≤‡∏¢','‡πÅ‡∏™‡∏ô‡∏™‡∏∏‡∏Ç','‡∏Å‡∏•‡πâ‡∏≤‡∏´‡∏≤‡∏ç','‡∏ó‡∏≠‡∏á‡πÅ‡∏ó‡πâ','‡∏°‡∏µ‡∏ä‡∏±‡∏¢','‡∏®‡∏£‡∏µ‡∏™‡∏∏‡∏Ç','‡∏≠‡∏¥‡∏ô‡∏ó‡∏£','‡∏ß‡∏á‡∏©‡πå‡∏î‡∏µ','‡πÄ‡∏à‡∏£‡∏¥‡∏ç‡∏ú‡∏•','‡∏û‡∏π‡∏ô‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå','‡∏®‡∏±‡∏Å‡∏î‡∏¥‡πå‡∏®‡∏£‡∏µ','‡∏ß‡∏±‡∏í‡∏ô‡∏Å‡∏∏‡∏•','‡∏ó‡∏≠‡∏á‡∏´‡∏•‡πà‡∏≠','‡∏ô‡∏≤‡∏Ñ‡∏∞','‡∏™‡∏∏‡∏ß‡∏£‡∏£‡∏ì','‡∏õ‡∏£‡∏∞‡πÄ‡∏™‡∏£‡∏¥‡∏ê','‡∏Å‡∏¥‡∏ï‡∏ï‡∏¥‡∏Ñ‡∏∏‡∏ì','‡∏£‡∏±‡∏ï‡∏ô‡∏ß‡∏á‡∏®‡πå','‡∏ö‡∏∏‡∏ç‡∏™‡πà‡∏á','‡πÇ‡∏ä‡∏ï‡∏¥‡∏ä‡πà‡∏ß‡∏á','‡∏ò‡∏£‡∏£‡∏°‡∏£‡∏±‡∏Å‡∏©‡πå','‡∏®‡∏∏‡∏†‡∏Å‡∏¥‡∏à','‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏û‡∏π‡∏ô','‡∏ß‡∏¥‡∏£‡∏¥‡∏¢‡∏∞','‡∏™‡∏∏‡∏ô‡∏ó‡∏£','‡∏à‡∏á‡πÄ‡∏à‡∏£‡∏¥‡∏ç','‡∏ô‡∏¥‡∏•‡∏ß‡∏£‡∏£‡∏ì','‡∏Ñ‡∏≥‡πÅ‡∏õ‡∏á','‡∏û‡∏á‡∏©‡πå‡∏î‡∏µ','‡πÅ‡∏™‡∏á‡πÉ‡∏™'];

const thaiAddressMap = [
  {prov:'‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£',dist:'‡πÄ‡∏Ç‡∏ï‡∏ö‡∏≤‡∏á‡∏£‡∏±‡∏Å',subdist:'‡πÅ‡∏Ç‡∏ß‡∏á‡∏ö‡∏≤‡∏á‡∏£‡∏±‡∏Å',zip:'10500'},
  {prov:'‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£',dist:'‡πÄ‡∏Ç‡∏ï‡∏õ‡∏ó‡∏∏‡∏°‡∏ß‡∏±‡∏ô',subdist:'‡πÅ‡∏Ç‡∏ß‡∏á‡∏õ‡∏ó‡∏∏‡∏°‡∏ß‡∏±‡∏ô',zip:'10330'},
  {prov:'‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£',dist:'‡πÄ‡∏Ç‡∏ï‡∏à‡∏ï‡∏∏‡∏à‡∏±‡∏Å‡∏£',subdist:'‡πÅ‡∏Ç‡∏ß‡∏á‡∏•‡∏≤‡∏î‡∏¢‡∏≤‡∏ß',zip:'10900'},
  {prov:'‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£',dist:'‡πÄ‡∏Ç‡∏ï‡∏ö‡∏≤‡∏á‡πÄ‡∏Ç‡∏ô',subdist:'‡πÅ‡∏Ç‡∏ß‡∏á‡∏≠‡∏ô‡∏∏‡∏™‡∏≤‡∏ß‡∏£‡∏µ‡∏¢‡πå',zip:'10220'},
  {prov:'‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà',dist:'‡∏≠‡∏≥‡πÄ‡∏†‡∏≠‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà',subdist:'‡∏ï‡∏≥‡∏ö‡∏•‡∏™‡∏∏‡πÄ‡∏ó‡∏û',zip:'50200'},
  {prov:'‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡∏£‡∏≤‡∏¢',dist:'‡∏≠‡∏≥‡πÄ‡∏†‡∏≠‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡∏£‡∏≤‡∏¢',subdist:'‡∏ï‡∏≥‡∏ö‡∏•‡∏£‡∏≠‡∏ö‡πÄ‡∏ß‡∏µ‡∏¢‡∏á',zip:'57000'},
  {prov:'‡∏Ç‡∏≠‡∏ô‡πÅ‡∏Å‡πà‡∏ô',dist:'‡∏≠‡∏≥‡πÄ‡∏†‡∏≠‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏Ç‡∏≠‡∏ô‡πÅ‡∏Å‡πà‡∏ô',subdist:'‡∏ï‡∏≥‡∏ö‡∏•‡πÉ‡∏ô‡πÄ‡∏°‡∏∑‡∏≠‡∏á',zip:'40000'},
  {prov:'‡∏ô‡∏Ñ‡∏£‡∏£‡∏≤‡∏ä‡∏™‡∏µ‡∏°‡∏≤',dist:'‡∏≠‡∏≥‡πÄ‡∏†‡∏≠‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏ô‡∏Ñ‡∏£‡∏£‡∏≤‡∏ä‡∏™‡∏µ‡∏°‡∏≤',subdist:'‡∏ï‡∏≥‡∏ö‡∏•‡πÉ‡∏ô‡πÄ‡∏°‡∏∑‡∏≠‡∏á',zip:'30000'},
  {prov:'‡∏ä‡∏•‡∏ö‡∏∏‡∏£‡∏µ',dist:'‡∏≠‡∏≥‡πÄ‡∏†‡∏≠‡∏®‡∏£‡∏µ‡∏£‡∏≤‡∏ä‡∏≤',subdist:'‡∏ï‡∏≥‡∏ö‡∏•‡∏™‡∏∏‡∏£‡∏®‡∏±‡∏Å‡∏î‡∏¥‡πå',zip:'20110'},
  {prov:'‡∏†‡∏π‡πÄ‡∏Å‡πá‡∏ï',dist:'‡∏≠‡∏≥‡πÄ‡∏†‡∏≠‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏†‡∏π‡πÄ‡∏Å‡πá‡∏ï',subdist:'‡∏ï‡∏≥‡∏ö‡∏•‡∏ï‡∏•‡∏≤‡∏î‡πÉ‡∏´‡∏ç‡πà',zip:'83000'}
];

const thaiStreets = ['‡∏™‡∏∏‡∏Ç‡∏∏‡∏°‡∏ß‡∏¥‡∏ó','‡∏û‡∏´‡∏•‡πÇ‡∏¢‡∏ò‡∏¥‡∏ô','‡∏ß‡∏¥‡∏†‡∏≤‡∏ß‡∏î‡∏µ‡∏£‡∏±‡∏á‡∏™‡∏¥‡∏ï','‡∏°‡∏¥‡∏ï‡∏£‡∏†‡∏≤‡∏û','‡πÄ‡∏à‡∏£‡∏¥‡∏ç‡∏Å‡∏£‡∏∏‡∏á','‡∏ô‡∏¥‡∏°‡∏°‡∏≤‡∏ô‡πÄ‡∏´‡∏°‡∏¥‡∏ô‡∏ó‡πå','‡∏£‡∏≤‡∏ä‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô','‡πÄ‡∏û‡∏ä‡∏£‡πÄ‡∏Å‡∏©‡∏°','‡∏®‡∏£‡∏µ‡∏ô‡∏Ñ‡∏£‡∏¥‡∏ô‡∏ó‡∏£‡πå','‡∏•‡∏≤‡∏î‡∏û‡∏£‡πâ‡∏≤‡∏ß'];

// =========================
// DATE HELPERS
// =========================
function parseDate(str) {
  const [d, t] = str.split(' ');
  const [day, mon, year] = d.split('/').map(Number);
  const [h, m] = t.split(':').map(Number);
  return new Date(year, mon - 1, day, h, m);
}

function formatDate(d) {
  const dd = String(d.getDate()).padStart(2, '0');
  const mm = String(d.getMonth() + 1).padStart(2, '0');
  const yyyy = d.getFullYear();
  const hh = String(d.getHours()).padStart(2, '0');
  const mi = String(d.getMinutes()).padStart(2, '0');
  return `${dd}/${mm}/${yyyy} ${hh}:${mi}`;
}

function addMinutes(dateObj, minutes) {
  const d = new Date(dateObj.getTime());
  d.setMinutes(d.getMinutes() + minutes);
  return formatDate(d);
}

// =========================
// DETERMINISTIC DATE 1-15 (LOCKED BY TRACKING)
// =========================
const now = new Date();

function hashCode(str) {
  let hash = 0;
  for (let i = 0; i < str.length; i++) {
    hash = ((hash << 5) - hash) + str.charCodeAt(i);
    hash |= 0;
  }
  return Math.abs(hash);
}

function dateFromTracking(track) {
  const seed = hashCode(track);
  const year = now.getFullYear();
  const month = now.getMonth();

  const day = 1 + (seed % 15);
  const hour = seed % 24;
  const minute = Math.floor(seed / 24) % 60;

  return new Date(year, month, day, hour, minute, 0);
}

// =========================
// SEED DATA (100 PARCELS)
// =========================
parcels.length = 0;

for (let i = 0; i < 100; i++) {
  const trackId = 'SKY' + (240001 + i);
  const baseDate = dateFromTracking(trackId);
  const baseTime = formatDate(baseDate);

  const senderName = '‡∏ô‡∏≤‡∏¢' + thaiFirstNames[i % thaiFirstNames.length] + ' ' + thaiLastNames[i % thaiLastNames.length];
  const addrPick = thaiAddressMap[i % thaiAddressMap.length];
  const street = thaiStreets[i % thaiStreets.length];

  let address = '';
  if (addrPick.prov === '‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£') {
    address = `‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà ${i + 1} ‡∏ñ‡∏ô‡∏ô${street} ${addrPick.subdist} ${addrPick.dist} ${addrPick.prov} ${addrPick.zip}`;
  } else {
    address = `‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà ${i + 1} ‡∏ñ‡∏ô‡∏ô${street} ${addrPick.subdist} ${addrPick.dist} ‡∏à.${addrPick.prov} ${addrPick.zip}`;
  }

  const events = [
    { point: '‡∏£‡∏±‡∏ö‡∏à‡∏≤‡∏Å‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á Kiosk', by: '‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà Kiosk ' + ((i % 4) + 1), phone: '08' + String(10000000 + i).padStart(8, '0'), time: baseTime },
    { point: '‡∏Ñ‡∏±‡∏î‡πÅ‡∏¢‡∏Å‡∏Ñ‡∏•‡∏±‡∏á', by: '‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ñ‡∏•‡∏±‡∏á ' + ((i % 3) + 1), phone: '08' + String(20000000 + i).padStart(8, '0'), time: addMinutes(baseDate, 45) },
    { point: '‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å', by: '‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏Ç‡∏ô‡∏™‡πà‡∏á ' + ((i % 2) + 1), phone: '08' + String(30000000 + i).padStart(8, '0'), time: addMinutes(baseDate, 120) }
  ];

  parcels.push({
    track: trackId,
    sentAt: baseTime,
    aot: AOTS[i % AOTS.length],
    sender: senderName,
    address: address,
    senderPhone: '08' + String(40000000 + i).padStart(8, '0'),
    weight: 300 + (i * 7) % 700,
    status: i % 2 === 0 ? '‡∏≠‡∏¢‡∏π‡πà‡∏Ñ‡∏•‡∏±‡∏á' : '‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß',
    events
  });
}

// =========================
// SORTING
// =========================
function updateSortIcons() {
  ['track','sentAt','aot','sender','address','senderPhone','weight','status'].forEach(k => {
    const el = document.getElementById('s-' + k);
    if (!el) return;
    if (sortState.key === k) {
      el.textContent = sortState.asc ? ' ‚ñ≤' : ' ‚ñº';
    } else {
      el.textContent = '';
    }
  });
}

function sortBy(key) {
  if (key === 'sentAt') {
    sortState.key = key;
    sortState.asc = false;
    _initialSortDone = true;
  } else if (!_initialSortDone) {
    sortState.key = key;
    sortState.asc = true;
    _initialSortDone = true;
  } else if (sortState.key === key) {
    sortState.asc = !sortState.asc;
  } else {
    sortState.key = key;
    sortState.asc = true;
  }

  parcels.sort((a, b) => {
    let va = a[key];
    let vb = b[key];

    if (key === 'sentAt') {
      va = parseDate(va);
      vb = parseDate(vb);
      const dA = new Date(va.getFullYear(), va.getMonth(), va.getDate());
      const dB = new Date(vb.getFullYear(), vb.getMonth(), vb.getDate());
      if (dA.getTime() !== dB.getTime()) {
        return sortState.asc ? dA - dB : dB - dA;
      }
      return sortState.asc ? va - vb : vb - va;
    }

    if (typeof va === 'number') {
      return sortState.asc ? va - vb : vb - va;
    }

    return sortState.asc
      ? String(va).localeCompare(String(vb))
      : String(vb).localeCompare(String(va));
  });

  updateSortIcons();
  render();
}

// =========================
// HIGHLIGHT HELPER (FIXED REGEX)
// =========================
function highlight(text){
  const q = (document.getElementById('searchInput').value || '').trim();
  if (!q) return text;
  try{
    // Properly escape regex special chars
    const qEsc = q.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    const re = new RegExp('(' + qEsc + ')', 'ig');
    return String(text).replace(re, '<span class="hl">$1</span>');
  }catch(e){
    return text;
  }
}

// =========================
// RENDERING
// =========================
function render() {
  const tb = document.getElementById('parcelTable');
  tb.innerHTML = '';
  let sin = 0, sout = 0;

  const qRaw = (document.getElementById('searchInput').value || '').trim().toLowerCase();

  // collect rows first so we can prioritize full Tracking matches
  const rows = [];

  parcels.forEach(p => {
    if (filter(p)) {
      const isFullMatch = qRaw && p.track.toLowerCase() === qRaw;

      rows.push({ p, isFullMatch });
    }
    p.status === '‡∏≠‡∏¢‡∏π‡πà‡∏Ñ‡∏•‡∏±‡∏á' ? sin++ : sout++;
  });

  // full match first, then keep original order
  rows.sort((a, b) => {
    if (a.isFullMatch && !b.isFullMatch) return -1;
    if (!a.isFullMatch && b.isFullMatch) return 1;
    return 0;
  });

  rows.forEach(({ p, isFullMatch }) => {
    tb.innerHTML += `
      <tr class="aot-${p.aot} ${isFullMatch ? 'full-match' : ''}">
        <td>${highlight(p.track)}</td>
        <td>${highlight(p.sentAt)}</td>
        <td>${highlight(p.aot)}</td>
        <td>${highlight(p.sender)}</td>
        <td>${highlight(p.address)}</td>
        <td>${highlight(p.senderPhone)}</td>
        <td>${p.weight} g</td>
        <td><span class="badge ${p.status === '‡∏≠‡∏¢‡∏π‡πà‡∏Ñ‡∏•‡∏±‡∏á' ? 'status-in' : 'status-out'}">${highlight(p.status)}</span></td>
        <td><button onclick="showTimeline('${p.track}')">‡∏î‡∏π Flow</button></td>
      </tr>
    `;
  });

  document.getElementById('sumAll').innerText = parcels.length;
  document.getElementById('sumIn').innerText = sin;
  document.getElementById('sumOut').innerText = sout;
}

function filter(p) {
  const fd = document.getElementById('filterDate').value;
  const q = (document.getElementById('searchInput').value || '').toLowerCase().trim();
  const fa = document.getElementById('filterAOT').value;
  const fs = document.getElementById('filterStatus').value;

  // Date match (input yyyy-mm-dd -> compare dd/mm/yyyy)
  let matchDate = true;
  if (fd) {
    const parts = fd.split('-');
    if (parts.length === 3) {
      const ddmmyyyy = parts[2] + '/' + parts[1] + '/' + parts[0];
      matchDate = p.sentAt.startsWith(ddmmyyyy);
    }
  }

  // Text search across multiple fields (case-insensitive, supports full tracking)
  let matchText = true;
  if (q) {
    const hay = [p.track, p.sender, p.address, p.senderPhone, p.aot, p.status]
      .join(' ')
      .toLowerCase();

    matchText = hay.includes(q);
  }

  const matchAOT = !fa || p.aot === fa;
  const matchStatus = !fs || p.status === fs;

  return matchDate && matchText && matchAOT && matchStatus;
}

function render() {
  const tb = document.getElementById('parcelTable');
  tb.innerHTML = '';
  let sin = 0, sout = 0;

  parcels.forEach(p => {
    if (filter(p)) {
      tb.innerHTML += `
        <tr class="aot-${p.aot}">
          <td>${highlight(p.track)}</td>
          <td>${highlight(p.sentAt)}</td>
          <td>${highlight(p.aot)}</td>
          <td>${highlight(p.sender)}</td>
          <td>${highlight(p.address)}</td>
          <td>${highlight(p.senderPhone)}</td>
          <td>${p.weight} g</td>
          <td><span class="badge ${p.status === '‡∏≠‡∏¢‡∏π‡πà‡∏Ñ‡∏•‡∏±‡∏á' ? 'status-in' : 'status-out'}">${highlight(p.status)}</span></td>
          <td><button onclick="showTimeline('${p.track}')">‡∏î‡∏π Flow</button></td>
        </tr>
      `;
    }
    p.status === '‡∏≠‡∏¢‡∏π‡πà‡∏Ñ‡∏•‡∏±‡∏á' ? sin++ : sout++;
  });

  document.getElementById('sumAll').innerText = parcels.length;
  document.getElementById('sumIn').innerText = sin;
  document.getElementById('sumOut').innerText = sout;
}

function filter(p) {
  const fd = document.getElementById('filterDate').value;
  const q = (document.getElementById('searchInput').value || '').toLowerCase().trim();
  const fa = document.getElementById('filterAOT').value;
  const fs = document.getElementById('filterStatus').value;

  // Date match (input yyyy-mm-dd -> compare dd/mm/yyyy)
  let matchDate = true;
  if (fd) {
    const parts = fd.split('-');
    if (parts.length === 3) {
      const ddmmyyyy = parts[2] + '/' + parts[1] + '/' + parts[0];
      matchDate = p.sentAt.startsWith(ddmmyyyy);
    }
  }

  // Text search across multiple fields (supports numeric-only tracking search)
  let matchText = true;
  if (q) {
    const hay = [p.track, p.sender, p.address, p.senderPhone, p.aot, p.status]
      .join(' ')
      .toLowerCase();

    const qDigits = q.replace(/\D/g, '');
    const trackDigits = p.track.replace(/\D/g, '');

    matchText = hay.includes(q) || (qDigits && trackDigits.includes(qDigits));
  }

  const matchAOT = !fa || p.aot === fa;
  const matchStatus = !fs || p.status === fs;

  return matchDate && matchText && matchAOT && matchStatus;
}

['searchInput','filterAOT','filterStatus','filterDate'].forEach(id => {
  const el = document.getElementById(id);
  if (!el) return;
  el.oninput = render;
  el.onchange = render;
});

// Allow Enter key to trigger search
const si = document.getElementById('searchInput');
if (si) {
  si.addEventListener('keyup', e => {
    if (e.key === 'Enter') render();
  });
}

function refreshPage() {
  document.getElementById('filterDate').value = '';
  document.getElementById('searchInput').value = '';
  document.getElementById('filterAOT').value = '';
  document.getElementById('filterStatus').value = '';
  sortState = { key: 'sentAt', asc: false };
  _initialSortDone = false;
  sortBy('sentAt');
}

// =========================
// QUICK FILTER FROM KPI CARDS
// =========================
function quickFilter(status){
  document.getElementById('filterStatus').value = status;
  document.getElementById('searchInput').value = '';
  document.getElementById('filterAOT').value = '';
  document.getElementById('filterDate').value = '';
  render();
  window.scrollTo({ top: document.querySelector('table').offsetTop - 80, behavior: 'smooth' });
}

// =========================
// EXPORTS
// =========================
function exportPDF() {
  const html = buildPDFHtml();

  let win = null;
  try {
    win = window.open('', '_blank');
  } catch (e) {
    win = null;
  }

  if (win && win.document) {
    win.document.open();
    win.document.write(html);
    win.document.close();
    win.focus();
    win.print();
  } else {
    const iframe = document.createElement('iframe');
    iframe.style.position = 'fixed';
    iframe.style.right = '0';
    iframe.style.bottom = '0';
    iframe.style.width = '0';
    iframe.style.height = '0';
    iframe.style.border = '0';
    document.body.appendChild(iframe);

    const doc = iframe.contentWindow.document;
    doc.open();
    doc.write(html);
    doc.close();

    iframe.contentWindow.focus();
    iframe.contentWindow.print();

    setTimeout(() => document.body.removeChild(iframe), 1000);
  }
}

function buildPDFHtml() {
  let html = '<html><head><title>SKYSEND PDF</title>' +
    '<style>body{font-family:Arial}h2{margin-top:20px}table{width:100%;border-collapse:collapse}td,th{border:1px solid #333;padding:6px;font-size:12px}</style>' +
    '</head><body>';

  html += '<h2>‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏û‡∏±‡∏™‡∏î‡∏∏ (‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏™‡∏ô‡∏≤‡∏°‡∏ö‡∏¥‡∏ô)</h2>';
  html += '<table><tr><th>Tracking</th><th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th><th>‡∏™‡∏ô‡∏≤‡∏°‡∏ö‡∏¥‡∏ô</th><th>‡∏ú‡∏π‡πâ‡∏™‡πà‡∏á</th><th>‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th></tr>';

  parcels.filter(p => filter(p)).forEach(p => {
    html += `<tr><td>${p.track}</td><td>${p.sentAt}</td><td>${p.aot}</td><td>${p.sender}</td><td>${p.address}</td><td>${p.status}</td></tr>`;
  });

  html += '</table></body></html>';
  return html;
}

function exportCSV() {
  const headers = ['Tracking','‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏∞‡∏ö‡∏ö','‡∏™‡∏ô‡∏≤‡∏°‡∏ö‡∏¥‡∏ô','‡∏ú‡∏π‡πâ‡∏™‡πà‡∏á','‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á','‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏ú‡∏π‡πâ‡∏™‡πà‡∏á','‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å(g)','‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞'];
  let csv = headers.join(',') + '\n';

  parcels.forEach(p => {
    if (!filter(p)) return;
    const row = [p.track,p.sentAt,p.aot,p.sender,p.address.replace(/,/g,' '),p.senderPhone,p.weight,p.status];
    csv += row.map(v => '"' + String(v).replace(/"/g,'""') + '"').join(',') + '\n';
  });

  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const link = document.createElement('a');
  link.href = url;
  link.download = 'skysend_parcels_export.csv';
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
}

// =========================
// FLOW DIALOG
// =========================
function showTimeline(track) {
  const p = parcels.find(x => x.track === track);
  if (!p) return;
  let html = '<h3>üì¶ Flow Diagram : ' + track + '</h3>';

  p.events.forEach((e, i) => {
    html += `
      <p>
        üîπ <strong>${i + 1}. ${e.point}</strong><br>
        üë§ ${e.by}<br>
        üìû ${e.phone}<br>
        ‚è∞ ${e.time}
      </p>
    `;
    if (i < p.events.length - 1) {
      html += '<p style="text-align:center">‚¨áÔ∏è</p>';
    }
  });

  html += '<button onclick="document.getElementById(\'timelineDialog\').close()">‡∏õ‡∏¥‡∏î</button>';
  const dialog = document.getElementById('timelineDialog');
  dialog.innerHTML = html;
  dialog.showModal();
}

// =========================
// BASIC TESTS
(function runTests(){
  console.assert(typeof refreshPage === 'function', 'refreshPage should be defined');
  console.assert(typeof exportCSV === 'function', 'exportCSV should be defined');
  console.assert(typeof exportPDF === 'function', 'exportPDF should be defined');
  console.assert(parcels.length === 100, 'Should seed exactly 100 parcels');

  // full tracking match should be found
  const testTrack = parcels[0].track;
  document.getElementById('searchInput').value = testTrack;
  console.assert(filter(parcels[0]) === true, 'Full tracking match should return true');
})();

// =========================
// =========================
(function runTests(){
  console.assert(typeof refreshPage === 'function', 'refreshPage should be defined');
  console.assert(typeof exportCSV === 'function', 'exportCSV should be defined');
  console.assert(typeof exportPDF === 'function', 'exportPDF should be defined');
  console.assert(parcels.length === 100, 'Should seed exactly 100 parcels');
})();

// Initial load
updateSortIcons();
sortBy('sentAt');
</script>
</body>
</html>
