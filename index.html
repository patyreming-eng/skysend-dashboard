<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SKYSEND Backoffice</title>
  <style>
    :root{--bg:#f0f7ff;--primary:#0ea5e9;--primary-dark:#0284c7;--card:#ffffff;--muted:#64748b;--border:#e2e8f0;--success:#16a34a;--danger:#dc2626;--radius:14px}
    *{box-sizing:border-box}
    body{font-family:Segoe UI,Tahoma,sans-serif;background:linear-gradient(180deg,#eef1ff 0%,var(--bg) 200px);margin:0;color:#111827}
    header{background:linear-gradient(135deg,var(--primary),#38bdf8);color:#fff;padding:16px 24px;box-shadow:0 4px 20px rgba(14,165,233,.35);position:sticky;top:0;z-index:10;display:flex;align-items:center;justify-content:space-between}
    header h1{margin:0;font-size:22px;letter-spacing:.3px}
    .container{padding:24px;max-width:1400px;margin:0 auto}
    .cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:20px;margin-bottom:24px}
    .card{background:var(--card);border-radius:var(--radius);padding:20px;box-shadow:0 10px 25px rgba(0,0,0,.08);cursor:pointer}
    .card h2{margin:0;font-size:14px;color:var(--muted);text-transform:uppercase;letter-spacing:.08em}
    .card p{font-size:32px;margin:10px 0 0;color:var(--primary);font-weight:700}
    .toolbar{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:16px;align-items:center;background:var(--card);padding:14px;border-radius:var(--radius);box-shadow:0 6px 20px rgba(0,0,0,.08)}
    .search-input{flex:1;min-width:320px;font-size:16px;padding:12px 14px;border:2px solid var(--primary);box-shadow:0 0 0 4px rgba(14,165,233,.15)}
    .toolbar input,.toolbar select,.toolbar button{padding:10px 12px;border-radius:10px;border:1px solid var(--border);font-size:14px;outline:none;background:#fff}
    .toolbar button{background:var(--primary);color:#fff;border:none;cursor:pointer;font-weight:600}
    .toolbar button.secondary{background:#9ca3af}
    table{width:100%;border-collapse:separate;border-spacing:0;background:var(--card);border-radius:var(--radius);overflow:hidden;box-shadow:0 10px 25px rgba(0,0,0,.08)}
    thead{background:#f9fafb}
    th,td{padding:12px 14px;text-align:left;border-bottom:1px solid var(--border)}
    th{font-weight:600;cursor:pointer;user-select:none;position:sticky;top:0;background:#f9fafb;z-index:5}
    tbody tr:hover{background:#e0f2fe}
    tr:nth-child(even){background:#f7f9ff} tr:nth-child(odd){background:#ffffff}
    .full-match{background:#bae6fd !important;border-left:6px solid var(--primary)}
    .hl{background:#fde047;color:#111827;padding:0 2px;border-radius:4px}
    .badge{padding:4px 12px;border-radius:999px;font-size:12px;font-weight:700;display:inline-block}
    .status-in{background:#e8f5e9;color:var(--success)} .status-out{background:#ffebee;color:var(--danger)}
    .table-wrap{overflow:auto;max-height:70vh;position:relative}
    #pagination button{margin:0 4px;padding:6px 10px;border-radius:8px;border:1px solid var(--border);background:#fff;cursor:pointer}
    #pagination button.active{background:var(--primary);color:#fff;border-color:var(--primary)}
  </style>
</head>
<body>
<header><h1>‚úàÔ∏è SKYSEND Backoffice Dashboard</h1></header>
<div class="container">
  <div class="cards">
    <div class="card" onclick="quickFilter('')"><h2>‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h2><p id="sumAll">0</p></div>
    <div class="card" onclick="quickFilter('‡∏≠‡∏¢‡∏π‡πà‡∏Ñ‡∏•‡∏±‡∏á')"><h2>‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏Ñ‡∏•‡∏±‡∏á</h2><p id="sumIn">0</p></div>
    <div class="card" onclick="quickFilter('‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß')"><h2>‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß</h2><p id="sumOut">0</p></div>
  </div>

  <form id="addForm" class="toolbar" onsubmit="return addParcelFromForm()">
    <input id="fTrack" placeholder="Tracking" required />
    <input id="fSender" placeholder="‡∏ú‡∏π‡πâ‡∏™‡πà‡∏á" required />
    <input id="fAddress" placeholder="‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á" required />
    <input id="fPhone" placeholder="‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏ú‡∏π‡πâ‡∏™‡πà‡∏á" required />
    <select id="fAOT" required>
      <option value="">‡∏™‡∏ô‡∏≤‡∏°‡∏ö‡∏¥‡∏ô</option><option value="BKK">BKK</option><option value="DMK">DMK</option><option value="CNX">CNX</option><option value="HKT">HKT</option><option value="HDY">HDY</option><option value="CEI">CEI</option>
    </select>
    <select id="fStatus" required><option value="‡∏≠‡∏¢‡∏π‡πà‡∏Ñ‡∏•‡∏±‡∏á">‡∏≠‡∏¢‡∏π‡πà‡∏Ñ‡∏•‡∏±‡∏á</option><option value="‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß">‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß</option></select>
    <button type="submit">‚ûï ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏û‡∏±‡∏™‡∏î‡∏∏</button>
  </form>

  <div class="toolbar">
    <input id="searchInput" class="search-input" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ Tracking / ‡∏ä‡∏∑‡πà‡∏≠ / ‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà / ‡πÄ‡∏ö‡∏≠‡∏£‡πå" />
    <input type="date" id="filterDate" />
    <select id="filterAOT"><option value="">‡∏ó‡∏∏‡∏Å‡∏™‡∏ô‡∏≤‡∏°‡∏ö‡∏¥‡∏ô</option><option value="BKK">BKK</option><option value="DMK">DMK</option><option value="CNX">CNX</option><option value="HKT">HKT</option><option value="HDY">HDY</option><option value="CEI">CEI</option></select>
    <select id="filterStatus"><option value="">‡∏ó‡∏∏‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</option><option value="‡∏≠‡∏¢‡∏π‡πà‡∏Ñ‡∏•‡∏±‡∏á">‡∏≠‡∏¢‡∏π‡πà‡∏Ñ‡∏•‡∏±‡∏á</option><option value="‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß">‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß</option></select>
    <button type="button" onclick="exportCSV()">üìÑ Export CSV</button>
    <button type="button" class="secondary" onclick="exportPDF()">üì¶ Export PDF ‡∏ï‡∏≤‡∏°‡∏™‡∏ô‡∏≤‡∏°‡∏ö‡∏¥‡∏ô</button>
    <button type="button" class="secondary" onclick="refreshPage()">üîÑ Refresh</button>
  </div>

  <div id="pagination"></div>
  <div class="table-wrap"><table>
    <thead><tr>
      <th onclick="sortBy('track')">Tracking</th>
      <th onclick="sortBy('sentAt')">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏∞‡∏ö‡∏ö</th>
      <th onclick="sortBy('aot')">‡∏™‡∏ô‡∏≤‡∏°‡∏ö‡∏¥‡∏ô</th>
      <th onclick="sortBy('sender')">‡∏ú‡∏π‡πâ‡∏™‡πà‡∏á</th>
      <th onclick="sortBy('address')">‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á</th>
      <th onclick="sortBy('senderPhone')">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏ú‡∏π‡πâ‡∏™‡πà‡∏á</th>
      <th onclick="sortBy('weight')">‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å</th>
      <th onclick="sortBy('status')">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
      <th>Flow</th>
    </tr></thead>
    <tbody id="parcelTable"></tbody>
  </table></div>
</div>

<dialog id="timelineDialog"></dialog>

<script>
// =========================
// STATE
// =========================
const parcels = [];
let sortState = { key: 'sentAt', asc: false };
let currentPage = 1;
const pageSize = 50;

// =========================
// GOOGLE SHEET LOAD
// =========================
const API_URL = 'https://script.google.com/macros/s/AKfycbxlhLZlHeCbjQKNUg6GFcYwEMACIN2kxxdfXjVzv2ogBcMEUE5ikDVX1qx6nXjmLT23FA/exec';

async function loadFromSheet(){
  try{
    const res = await fetch(API_URL);
    const text = await res.text();
    let data;
    try{ data = JSON.parse(text); }
    catch(e){ console.error('Response is not JSON:', text); alert('API ‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà JSON'); return; }

    parcels.length = 0;
    if(Array.isArray(data)){
      data.forEach(r=>{
        if(!r || !r.Tracking) return;
        parcels.push({
          track: String(r.Tracking),
          sentAt: r['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏∞‡∏ö‡∏ö'] || '',
          aot: r['‡∏™‡∏ô‡∏≤‡∏°‡∏ö‡∏¥‡∏ô'] || '',
          sender: r['‡∏ú‡∏π‡πâ‡∏™‡πà‡∏á'] || '',
          address: r['‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á'] || '',
          senderPhone: r['‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏ú‡∏π‡πâ‡∏™‡πà‡∏á'] || '',
          weight: Number(r['‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å (‡∏Å‡∏£‡∏±‡∏°)'] || 0),
          status: r['‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞'] || '',
          events: []
        });
      });
    } else {
      console.error('Unexpected data format:', data);
      alert('‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Google Sheet ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
      return;
    }
    currentPage = 1;
    render();
  }catch(e){
    console.error('Load sheet error', e);
    alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Google Sheet ‡πÑ‡∏î‡πâ');
  }
}

window.addEventListener('load', loadFromSheet);

// =========================
// HELPERS
// =========================
function parseDate(str){
  if(!str) return new Date(0);
  const parts=str.split(' ');
  if(parts.length<2) return new Date(0);
  const d=parts[0], t=parts[1];
  const a=d.split('/').map(Number);
  const b=t.split(':').map(Number);
  if(a.length!==3||b.length!==2) return new Date(0);
  return new Date(a[2],a[1]-1,a[0],b[0],b[1]);
}
function formatDate(d){
  const dd=String(d.getDate()).padStart(2,'0');
  const mm=String(d.getMonth()+1).padStart(2,'0');
  const yyyy=d.getFullYear();
  const hh=String(d.getHours()).padStart(2,'0');
  const mi=String(d.getMinutes()).padStart(2,'0');
  return dd+'/'+mm+'/'+yyyy+' '+hh+':'+mi;
}
function escapeHtml(s){
  return String(s).replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;' }[m]));
}
function highlight(text){
  const q=(document.getElementById('searchInput').value||'').trim();
  if(!q) return escapeHtml(text);
  try{
    const qEsc=q.replace(/[.*+?^${}()|[\]\\]/g,'\\$&');
    const re=new RegExp('('+qEsc+')','ig');
    return escapeHtml(String(text)).replace(re,'<span class="hl">$1</span>');
  }catch(e){
    return escapeHtml(text);
  }
}

// =========================
// PAGINATION
// =========================
function paginate(arr){ const start=(currentPage-1)*pageSize; return arr.slice(start, start+pageSize); }
function renderPagination(total){
  const el=document.getElementById('pagination');
  if(!el) return;
  const pageCount=Math.max(1, Math.ceil(total/pageSize));
  let html='';
  for(let i=1;i<=pageCount;i++){
    html += '<button type="button" class="'+(i===currentPage?'active':'')+'" onclick="gotoPage('+i+')">'+i+'</button>';
  }
  el.innerHTML = html;
}
function gotoPage(p){ currentPage=p; render(); }

// =========================
// FILTER / SORT / RENDER
// =========================
function filterRow(p){
  if(!p) return false;
  const fd=document.getElementById('filterDate').value;
  const q=(document.getElementById('searchInput').value||'').toLowerCase().trim();
  const fa=document.getElementById('filterAOT').value;
  const fs=document.getElementById('filterStatus').value;
  let matchDate=true;
  if(fd&&p.sentAt){
    const parts=fd.split('-');
    if(parts.length===3){
      const ddmmyyyy=parts[2]+'/'+parts[1]+'/'+parts[0];
      matchDate=p.sentAt.startsWith(ddmmyyyy);
    }
  }
  let matchText=true;
  if(q){
    const hay=[p.track,p.sender,p.address,p.senderPhone,p.aot,p.status].join(' ').toLowerCase();
    matchText=hay.includes(q);
  }
  const matchAOT=!fa||p.aot===fa;
  const matchStatus=!fs||p.status===fs;
  return matchDate&&matchText&&matchAOT&&matchStatus;
}

function sortBy(key){
  sortState.key=key;
  sortState.asc = key==='sentAt' ? false : !sortState.asc;
  parcels.sort((a,b)=>{
    let va=a[key], vb=b[key];
    if(key==='sentAt'){
      va=parseDate(va); vb=parseDate(vb);
      return sortState.asc?va-vb:vb-va;
    }
    if(typeof va==='number') return sortState.asc?va-vb:vb-va;
    return sortState.asc?String(va).localeCompare(String(vb)):String(vb).localeCompare(String(va));
  });
  currentPage=1; render();
}

function render(){
  const tb=document.getElementById('parcelTable');
  if(!tb) return;
  tb.innerHTML='';
  let sin=0,sout=0;
  const qRaw=(document.getElementById('searchInput').value||'').trim().toLowerCase();
  const rows=[];
  parcels.forEach(p=>{
    if(filterRow(p)){
      const isFullMatch = qRaw && p.track && p.track.toLowerCase()===qRaw;
      rows.push({p,isFullMatch});
    }
    if(p&&p.status==='‡∏≠‡∏¢‡∏π‡πà‡∏Ñ‡∏•‡∏±‡∏á') sin++; else if(p&&p.status==='‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß') sout++;
  });
  rows.sort((a,b)=> (a.isFullMatch===b.isFullMatch)?0:(a.isFullMatch?-1:1));

  const pageRows = paginate(rows);
  pageRows.forEach(({p,isFullMatch})=>{
    tb.innerHTML += '<tr class="'+(isFullMatch?'full-match':'')+'">'
      +'<td>'+highlight(p.track)+'</td>'
      +'<td>'+highlight(p.sentAt)+'</td>'
      +'<td>'+highlight(p.aot)+'</td>'
      +'<td>'+highlight(p.sender)+'</td>'
      +'<td>'+highlight(p.address)+'</td>'
      +'<td>'+highlight(p.senderPhone)+'</td>'
      +'<td>'+escapeHtml(p.weight)+' g</td>'
      +'<td><span class="badge '+(p.status==='‡∏≠‡∏¢‡∏π‡πà‡∏Ñ‡∏•‡∏±‡∏á'?'status-in':'status-out')+'">'+highlight(p.status)+'</span></td>'
      +'<td><button type="button" onclick="showTimeline(\''+escapeHtml(p.track)+'\')">‡∏î‡∏π Flow</button></td>'
      +'</tr>';
  });

  document.getElementById('sumAll').innerText=parcels.length;
  document.getElementById('sumIn').innerText=sin;
  document.getElementById('sumOut').innerText=sout;

  renderPagination(rows.length);
}

['searchInput','filterAOT','filterStatus','filterDate'].forEach(id=>{
  const el=document.getElementById(id);
  if(el){ el.oninput=()=>{ currentPage=1; render(); }; el.onchange=()=>{ currentPage=1; render(); }; }
});

function refreshPage(){
  document.getElementById('filterDate').value='';
  document.getElementById('searchInput').value='';
  document.getElementById('filterAOT').value='';
  document.getElementById('filterStatus').value='';
  sortState={key:'sentAt',asc:false};
  currentPage=1; render();
}
function quickFilter(status){
  document.getElementById('filterStatus').value=status;
  document.getElementById('searchInput').value='';
  document.getElementById('filterAOT').value='';
  document.getElementById('filterDate').value='';
  currentPage=1; render();
}

// =========================
// FORM ADD (SAVE TO GOOGLE SHEET)
// =========================
async function addParcelFromForm(){
  const payload = {
    Tracking: fTrack.value.trim(),
    sentAt: formatDate(new Date()),
    aot: fAOT.value,
    sender: fSender.value.trim(),
    address: fAddress.value.trim(),
    senderPhone: fPhone.value.trim(),
    weight: 500,
    status: fStatus.value
  };
  try{
    const res = await fetch(API_URL,{ method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
    const result = await res.json();
    if(result && result.status === 'ok'){
      await loadFromSheet();
      document.getElementById('addForm').reset();
      alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
    }else{
      alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: '+((result&&result.message)||'Unknown error'));
    }
  }catch(e){
    alert('‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Google Sheet ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
    console.error(e);
  }
  return false;
}

// =========================
// EXPORTS
// =========================
function exportCSV(){
  const headers=['Tracking','‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏∞‡∏ö‡∏ö','‡∏™‡∏ô‡∏≤‡∏°‡∏ö‡∏¥‡∏ô','‡∏ú‡∏π‡πâ‡∏™‡πà‡∏á','‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á','‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏ú‡∏π‡πâ‡∏™‡πà‡∏á','‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å(g)','‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞'];
  let csv=headers.join(',')+'\n';
  parcels.forEach(p=>{
    if(!filterRow(p)) return;
    const row=[p.track,p.sentAt,p.aot,p.sender,p.address.replace(/,/g,' '),p.senderPhone,p.weight,p.status];
    csv += row.map(v=>'"'+String(v).replace(/"/g,'""')+'"').join(',')+'\n';
  });
  const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download='skysend_parcels_export.csv';
  document.body.appendChild(a); a.click(); document.body.removeChild(a);
}
function exportPDF(){ alert('PDF export preview: ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡∏´‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡πÄ‡∏ï‡πá‡∏°‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö'); }

// =========================
// FLOW (FIXED STRING ESCAPING)
// =========================
function showTimeline(track){
  const p=parcels.find(x=>x&&x.track===track);
  if(!p){ alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏±‡∏™‡∏î‡∏∏'); return; }
  const dialog=document.getElementById('timelineDialog');
  dialog.innerHTML = `<h3>üì¶ Flow Diagram : ${escapeHtml(track)}</h3>
    <p>(‡πÇ‡∏´‡∏°‡∏î‡∏û‡∏£‡∏µ‡∏ß‡∏¥‡∏ß)</p>
    <button type="button" onclick="document.getElementById('timelineDialog').close()">‡∏õ‡∏¥‡∏î</button>`;
  dialog.showModal();
}

// =========================
// BASIC TESTS (ADDED)
// =========================
(function runTests(){
  console.assert(document.getElementById('pagination')!==null,'pagination element must exist');
  console.assert(typeof render==='function','render should be defined');
  console.assert(typeof renderPagination==='function','renderPagination should be defined');
  console.assert(typeof loadFromSheet==='function','loadFromSheet should be defined');
})();
</script>
</body>
</html>
