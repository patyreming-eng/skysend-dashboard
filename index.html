<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SKYSEND Backoffice</title>
  <style>
    body{font-family:Segoe UI, Tahoma, sans-serif;background:#f4f6f8;margin:0}
    header{background:#667eea;color:#fff;padding:20px}
    header h1{margin:0;font-size:24px}
    .container{padding:20px}
    .cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:20px;margin-bottom:20px}
    .card{background:#fff;border-radius:12px;padding:20px;box-shadow:0 4px 12px rgba(0,0,0,.1)}
    .card h2{margin:0;font-size:16px;color:#555}
    .card p{font-size:30px;margin:10px 0 0;color:#667eea;font-weight:bold}
    table{width:100%;border-collapse:collapse;background:#fff;border-radius:12px;overflow:hidden;box-shadow:0 4px 12px rgba(0,0,0,.1)}
    th,td{padding:12px 15px;text-align:left}
    th{background:#eee;font-weight:600;cursor:pointer;user-select:none}
    th span{font-size:12px;color:#666;margin-left:4px}
    tr:nth-child(even){background:#fafafa}
    .badge{padding:4px 10px;border-radius:20px;font-size:12px;font-weight:600}
    .aot{background:#e3f2fd;color:#1565c0}
    .status-in{background:#e8f5e9;color:#2e7d32}
    .status-out{background:#ffebee;color:#c62828}
    .toolbar{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:15px;align-items:center}
    .toolbar input,.toolbar select,.toolbar button{padding:10px;border-radius:8px;border:1px solid #ccc;font-size:14px}
    .toolbar button{background:#667eea;color:#fff;border:none;cursor:pointer}
    .toolbar button.secondary{background:#999}
    dialog{border:none;border-radius:12px;padding:20px;box-shadow:0 10px 30px rgba(0,0,0,.3)}
  </style>
</head>
<body>
<header>
  <h1>‚úàÔ∏è SKYSEND Backoffice</h1>
</header>

<div class="container">
  <div class="cards">
    <div class="card"><h2>‡∏û‡∏±‡∏™‡∏î‡∏∏‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h2><p id="sumAll">0</p></div>
    <div class="card"><h2>‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏Ñ‡∏•‡∏±‡∏á</h2><p id="sumIn">0</p></div>
    <div class="card"><h2>‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß</h2><p id="sumOut">0</p></div>
    <div class="card"><h2>‡∏™‡∏ô‡∏≤‡∏°‡∏ö‡∏¥‡∏ô</h2><p>6</p></div>
  </div>

  <div class="toolbar">
    <input type="date" id="filterDate" />
    <input type="text" id="searchInput" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ Tracking / ‡∏ú‡∏π‡πâ‡∏™‡πà‡∏á / ‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà / ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏ú‡∏π‡πâ‡∏™‡πà‡∏á" />
    <select id="filterAOT">
      <option value="">‡∏ó‡∏∏‡∏Å‡∏™‡∏ô‡∏≤‡∏°‡∏ö‡∏¥‡∏ô</option>
      <option>BKK</option><option>DMK</option><option>CNX</option><option>HKT</option><option>HDY</option><option>CEI</option>
    </select>
    <select id="filterStatus">
      <option value="">‡∏ó‡∏∏‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</option>
      <option value="‡∏≠‡∏¢‡∏π‡πà‡∏Ñ‡∏•‡∏±‡∏á">‡∏≠‡∏¢‡∏π‡πà‡∏Ñ‡∏•‡∏±‡∏á</option>
      <option value="‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß">‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß</option>
    </select>
    <button class="secondary" onclick="refreshPage()">üîÑ Refresh</button>
  </div>

  <table>
    <thead>
      <tr>
        <th onclick="sortBy('track')">Tracking<span id="s-track"></span></th>
        <th onclick="sortBy('sentAt')">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏∞‡∏ö‡∏ö<span id="s-sentAt"></span></th>
        <th onclick="sortBy('aot')">‡∏™‡∏ô‡∏≤‡∏°‡∏ö‡∏¥‡∏ô<span id="s-aot"></span></th>
        <th onclick="sortBy('sender')">‡∏ú‡∏π‡πâ‡∏™‡πà‡∏á<span id="s-sender"></span></th>
        <th onclick="sortBy('address')">‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á<span id="s-address"></span></th>
        <th onclick="sortBy('senderPhone')">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏ú‡∏π‡πâ‡∏™‡πà‡∏á<span id="s-senderPhone"></span></th>
        <th onclick="sortBy('weight')">‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å<span id="s-weight"></span></th>
        <th onclick="sortBy('status')">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞<span id="s-status"></span></th>
        <th>Flow</th>
      </tr>
    </thead>
    <tbody id="parcelTable"></tbody>
  </table>
</div>

<dialog id="timelineDialog"></dialog>

<script>
// =========================
// DATA + UTILITIES
// =========================
const parcels = [];
const AOTS = ['BKK','DMK','CNX','HKT','HDY','CEI'];

// ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏∞‡∏ö‡∏ö (‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏Å‡πà‡∏≠‡∏ô)
let sortState = { key: 'sentAt', asc: false };
let _initialSortDone = false;

// =========================
// MASTER DATA
// =========================
const thaiFirstNames = ['‡∏ò‡∏ô‡∏û‡∏•','‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏ô‡∏Å','‡∏™‡∏°‡∏®‡∏±‡∏Å‡∏î‡∏¥‡πå','‡∏Å‡∏≤‡∏ô‡∏ï‡πå‡∏ä‡∏ô‡∏Å','‡∏ß‡∏£‡∏û‡∏•','‡∏ä‡∏•‡∏ò‡∏¥‡∏ä‡∏≤','‡∏≠‡∏†‡∏¥‡∏ä‡∏≤‡∏ï‡∏¥','‡∏•‡∏•‡∏¥‡∏ï‡∏≤','‡∏õ‡∏£‡∏µ‡∏ä‡∏≤','‡∏ò‡∏±‡∏ç‡∏ç‡∏≤','‡∏™‡∏∏‡∏û‡∏à‡∏ô‡πå','‡∏≠‡∏£‡∏≠‡∏ô‡∏á‡∏Ñ‡πå','‡∏Å‡∏¥‡∏ï‡∏ï‡∏¥‡∏û‡∏á‡∏©‡πå','‡∏®‡∏¥‡∏£‡∏¥‡∏û‡∏£','‡∏°‡∏ô‡∏±‡∏™','‡∏ß‡∏£‡∏≤‡∏†‡∏£‡∏ì‡πå','‡∏≠‡∏ô‡∏∏‡∏ä‡∏≤','‡∏û‡∏±‡∏ä‡∏£‡∏µ','‡∏ò‡∏µ‡∏£‡∏û‡∏á‡∏©‡πå','‡∏Å‡∏°‡∏•‡∏ä‡∏ô‡∏Å','‡∏™‡∏±‡∏ô‡∏ï‡∏¥','‡∏õ‡∏ß‡∏µ‡∏ì‡∏≤','‡∏≠‡∏≥‡∏ô‡∏≤‡∏à','‡∏ô‡∏§‡∏°‡∏•','‡∏™‡∏∏‡∏ä‡∏≤‡∏ï‡∏¥','‡∏£‡∏±‡∏ï‡∏ô‡∏≤','‡πÑ‡∏û‡∏®‡∏≤‡∏•','‡πÄ‡∏ö‡∏ç‡∏à‡∏°‡∏≤‡∏®','‡∏ì‡∏±‡∏ê‡∏û‡∏•','‡∏õ‡∏ì‡∏¥‡∏ò‡∏≤‡∏ô','‡∏à‡∏¥‡∏£‡∏≤‡∏†‡∏£‡∏ì‡πå','‡∏ß‡∏≤‡∏™‡∏ô‡∏≤','‡πÄ‡∏î‡∏ä‡∏≤‡∏ò‡∏£','‡∏≠‡∏±‡∏à‡∏â‡∏£‡∏≤','‡∏û‡∏¥‡∏ä‡∏¥‡∏ï','‡∏†‡∏±‡∏ó‡∏£‡∏ß‡∏î‡∏µ','‡∏ä‡∏≤‡∏ç‡∏ä‡∏±‡∏¢','‡∏ì‡∏±‡∏ê‡∏Å‡∏≤‡∏ô‡∏ï‡πå','‡∏Å‡∏∏‡∏•‡∏ò‡∏¥‡∏î‡∏≤','‡∏ß‡∏∏‡∏í‡∏¥‡∏ä‡∏±‡∏¢','‡∏®‡∏®‡∏¥‡∏ò‡∏£','‡∏ò‡∏ß‡∏±‡∏ä‡∏ä‡∏±‡∏¢','‡∏õ‡∏£‡∏µ‡∏¢‡∏≤‡∏ô‡∏∏‡∏ä','‡∏à‡∏≤‡∏£‡∏∏‡∏ß‡∏£‡∏£‡∏ì','‡∏õ‡∏Å‡∏£‡∏ì‡πå','‡∏≠‡∏¥‡∏™‡∏£‡∏µ‡∏¢‡πå','‡∏ò‡∏µ‡∏£‡∏®‡∏±‡∏Å‡∏î‡∏¥‡πå','‡∏î‡∏ß‡∏á‡πÉ‡∏à','‡∏®‡∏∏‡∏†‡∏ä‡∏±‡∏¢','‡∏Ç‡∏ß‡∏±‡∏ç‡∏§‡∏î‡∏µ'];

const thaiLastNames = ['‡∏®‡∏£‡∏µ‡∏ä‡∏±‡∏¢','‡∏ß‡∏±‡∏í‡∏ô‡∏≤','‡∏ö‡∏∏‡∏ç‡∏°‡∏≤','‡∏û‡∏£‡∏´‡∏°‡∏°‡∏≤','‡∏≠‡∏¥‡∏ô‡∏ó‡∏£‡πå‡∏ó‡∏≠‡∏á','‡∏°‡∏ì‡∏µ‡∏£‡∏±‡∏ï‡∏ô‡πå','‡πÅ‡∏Å‡πâ‡∏ß‡∏Ñ‡∏≥','‡∏™‡∏≤‡∏¢‡∏ó‡∏≠‡∏á','‡∏Ñ‡∏≥‡∏î‡∏µ','‡∏™‡∏∏‡∏Ç‡πÉ‡∏à','‡πÅ‡∏™‡∏ô‡∏î‡∏µ','‡πÉ‡∏à‡∏ö‡∏∏‡∏ç','‡∏ß‡∏á‡∏®‡πå‡∏ä‡∏±‡∏¢','‡πÅ‡∏Å‡πâ‡∏ß‡πÉ‡∏™','‡∏£‡∏∏‡πà‡∏á‡πÄ‡∏£‡∏∑‡∏≠‡∏á','‡∏û‡∏π‡∏•‡∏ú‡∏•','‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå‡∏î‡∏µ','‡πÅ‡∏î‡∏á‡∏î‡∏µ','‡πÅ‡∏™‡∏á‡∏ó‡∏≠‡∏á','‡∏ß‡∏¥‡πÄ‡∏®‡∏©','‡∏™‡∏∏‡∏Ç‡∏™‡∏ö‡∏≤‡∏¢','‡πÅ‡∏™‡∏ô‡∏™‡∏∏‡∏Ç','‡∏Å‡∏•‡πâ‡∏≤‡∏´‡∏≤‡∏ç','‡∏ó‡∏≠‡∏á‡πÅ‡∏ó‡πâ','‡∏°‡∏µ‡∏ä‡∏±‡∏¢','‡∏®‡∏£‡∏µ‡∏™‡∏∏‡∏Ç','‡∏≠‡∏¥‡∏ô‡∏ó‡∏£','‡∏ß‡∏á‡∏©‡πå‡∏î‡∏µ','‡πÄ‡∏à‡∏£‡∏¥‡∏ç‡∏ú‡∏•','‡∏û‡∏π‡∏ô‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå','‡∏®‡∏±‡∏Å‡∏î‡∏¥‡πå‡∏®‡∏£‡∏µ','‡∏ß‡∏±‡∏í‡∏ô‡∏Å‡∏∏‡∏•','‡∏ó‡∏≠‡∏á‡∏´‡∏•‡πà‡∏≠','‡∏ô‡∏≤‡∏Ñ‡∏∞','‡∏™‡∏∏‡∏ß‡∏£‡∏£‡∏ì','‡∏õ‡∏£‡∏∞‡πÄ‡∏™‡∏£‡∏¥‡∏ê','‡∏Å‡∏¥‡∏ï‡∏ï‡∏¥‡∏Ñ‡∏∏‡∏ì','‡∏£‡∏±‡∏ï‡∏ô‡∏ß‡∏á‡∏®‡πå','‡∏ö‡∏∏‡∏ç‡∏™‡πà‡∏á','‡πÇ‡∏ä‡∏ï‡∏¥‡∏ä‡πà‡∏ß‡∏á','‡∏ò‡∏£‡∏£‡∏°‡∏£‡∏±‡∏Å‡∏©‡πå','‡∏®‡∏∏‡∏†‡∏Å‡∏¥‡∏à','‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏û‡∏π‡∏ô','‡∏ß‡∏¥‡∏£‡∏¥‡∏¢‡∏∞','‡∏™‡∏∏‡∏ô‡∏ó‡∏£','‡∏à‡∏á‡πÄ‡∏à‡∏£‡∏¥‡∏ç','‡∏ô‡∏¥‡∏•‡∏ß‡∏£‡∏£‡∏ì','‡∏Ñ‡∏≥‡πÅ‡∏õ‡∏á','‡∏û‡∏á‡∏©‡πå‡∏î‡∏µ','‡πÅ‡∏™‡∏á‡πÉ‡∏™'];

const thaiAddressMap = [
  {prov:'‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£',dist:'‡∏ö‡∏≤‡∏á‡∏£‡∏±‡∏Å',zip:'10500'},
  {prov:'‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£',dist:'‡∏õ‡∏ó‡∏∏‡∏°‡∏ß‡∏±‡∏ô',zip:'10330'},
  {prov:'‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà',dist:'‡πÄ‡∏°‡∏∑‡∏≠‡∏á',zip:'50000'},
  {prov:'‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà',dist:'‡πÅ‡∏°‡πà‡∏£‡∏¥‡∏°',zip:'50180'},
  {prov:'‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡∏£‡∏≤‡∏¢',dist:'‡πÅ‡∏°‡πà‡∏™‡∏≤‡∏¢',zip:'57130'},
  {prov:'‡∏Ç‡∏≠‡∏ô‡πÅ‡∏Å‡πà‡∏ô',dist:'‡πÄ‡∏°‡∏∑‡∏≠‡∏á',zip:'40000'},
  {prov:'‡∏ô‡∏Ñ‡∏£‡∏£‡∏≤‡∏ä‡∏™‡∏µ‡∏°‡∏≤',dist:'‡πÄ‡∏°‡∏∑‡∏≠‡∏á',zip:'30000'},
  {prov:'‡∏ä‡∏•‡∏ö‡∏∏‡∏£‡∏µ',dist:'‡∏®‡∏£‡∏µ‡∏£‡∏≤‡∏ä‡∏≤',zip:'20110'},
  {prov:'‡∏£‡∏∞‡∏¢‡∏≠‡∏á',dist:'‡πÄ‡∏°‡∏∑‡∏≠‡∏á',zip:'21000'},
  {prov:'‡∏†‡∏π‡πÄ‡∏Å‡πá‡∏ï',dist:'‡πÄ‡∏°‡∏∑‡∏≠‡∏á',zip:'83000'},
  {prov:'‡∏™‡∏á‡∏Ç‡∏•‡∏≤',dist:'‡∏´‡∏≤‡∏î‡πÉ‡∏´‡∏ç‡πà',zip:'90110'},
  {prov:'‡∏™‡∏∏‡∏£‡∏≤‡∏©‡∏é‡∏£‡πå‡∏ò‡∏≤‡∏ô‡∏µ',dist:'‡πÄ‡∏Å‡∏≤‡∏∞‡∏™‡∏°‡∏∏‡∏¢',zip:'84320'},
  {prov:'‡∏ô‡∏Ñ‡∏£‡∏®‡∏£‡∏µ‡∏ò‡∏£‡∏£‡∏°‡∏£‡∏≤‡∏ä',dist:'‡∏ó‡∏∏‡πà‡∏á‡∏™‡∏á',zip:'80110'},
  {prov:'‡∏≠‡∏∏‡∏ö‡∏•‡∏£‡∏≤‡∏ä‡∏ò‡∏≤‡∏ô‡∏µ',dist:'‡∏ß‡∏≤‡∏£‡∏¥‡∏ô‡∏ä‡∏≥‡∏£‡∏≤‡∏ö',zip:'34190'},
  {prov:'‡∏≠‡∏∏‡∏î‡∏£‡∏ò‡∏≤‡∏ô‡∏µ',dist:'‡πÄ‡∏°‡∏∑‡∏≠‡∏á',zip:'41000'},
  {prov:'‡∏û‡∏¥‡∏©‡∏ì‡∏∏‡πÇ‡∏•‡∏Å',dist:'‡πÄ‡∏°‡∏∑‡∏≠‡∏á',zip:'65000'},
  {prov:'‡∏û‡∏£‡∏∞‡∏ô‡∏Ñ‡∏£‡∏®‡∏£‡∏µ‡∏ò‡∏£‡∏£‡∏°‡∏£‡∏≤‡∏ä',dist:'‡πÄ‡∏°‡∏∑‡∏≠‡∏á',zip:'13000'},
  {prov:'‡∏õ‡∏ó‡∏∏‡∏°‡∏ò‡∏≤‡∏ô‡∏µ',dist:'‡∏•‡∏≥‡∏•‡∏π‡∏Å‡∏Å‡∏≤',zip:'12150'},
  {prov:'‡∏ô‡∏ô‡∏ó‡∏ö‡∏∏‡∏£‡∏µ',dist:'‡∏õ‡∏≤‡∏Å‡πÄ‡∏Å‡∏£‡πá‡∏î',zip:'11120'},
  {prov:'‡∏™‡∏°‡∏∏‡∏ó‡∏£‡∏õ‡∏£‡∏≤‡∏Å‡∏≤‡∏£',dist:'‡∏ö‡∏≤‡∏á‡∏û‡∏•‡∏µ',zip:'10540'}
];

const thaiStreets = ['‡∏™‡∏∏‡∏Ç‡∏∏‡∏°‡∏ß‡∏¥‡∏ó','‡∏û‡∏´‡∏•‡πÇ‡∏¢‡∏ò‡∏¥‡∏ô','‡∏ß‡∏¥‡∏†‡∏≤‡∏ß‡∏î‡∏µ‡∏£‡∏±‡∏á‡∏™‡∏¥‡∏ï','‡∏°‡∏¥‡∏ï‡∏£‡∏†‡∏≤‡∏û','‡πÄ‡∏à‡∏£‡∏¥‡∏ç‡∏Å‡∏£‡∏∏‡∏á','‡∏ô‡∏¥‡∏°‡∏°‡∏≤‡∏ô‡πÄ‡∏´‡∏°‡∏¥‡∏ô‡∏ó‡πå','‡∏£‡∏≤‡∏ä‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô','‡πÄ‡∏û‡∏ä‡∏£‡πÄ‡∏Å‡∏©‡∏°','‡∏®‡∏£‡∏µ‡∏ô‡∏Ñ‡∏£‡∏¥‡∏ô‡∏ó‡∏£‡πå','‡∏•‡∏≤‡∏î‡∏û‡∏£‡πâ‡∏≤‡∏ß','‡∏£‡∏≤‡∏°‡∏Ñ‡∏≥‡πÅ‡∏´‡∏á','‡∏Å‡∏≤‡∏ç‡∏à‡∏ô‡∏≤‡∏†‡∏¥‡πÄ‡∏©‡∏Å','‡∏°‡∏´‡∏¥‡∏î‡∏•','‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏£‡∏≤‡∏©‡∏é‡∏£‡πå','‡∏≠‡∏∏‡∏î‡∏°‡∏™‡∏∏‡∏Ç','‡∏™‡∏±‡∏ô‡∏ï‡∏¥‡∏ò‡∏£‡∏£‡∏°','‡∏ó‡∏∏‡πà‡∏á‡∏£‡∏µ','‡∏™‡∏≤‡∏¢‡πÄ‡∏≠‡πÄ‡∏ä‡∏µ‡∏¢','‡∏ó‡πà‡∏≤‡πÅ‡∏û','‡πÅ‡∏°‡πà‡∏ü‡πâ‡∏≤‡∏´‡∏•‡∏ß‡∏á'];

// =========================
// DATE HELPERS
// =========================
function parseDate(str) {
  const [d, t] = str.split(' ');
  const [day, mon, year] = d.split('/').map(Number);
  const [h, m] = t.split(':').map(Number);
  return new Date(year, mon - 1, day, h, m);
}

function formatDate(d) {
  const dd = String(d.getDate()).padStart(2, '0');
  const mm = String(d.getMonth() + 1).padStart(2, '0');
  const yyyy = d.getFullYear();
  const hh = String(d.getHours()).padStart(2, '0');
  const mi = String(d.getMinutes()).padStart(2, '0');
  return `${dd}/${mm}/${yyyy} ${hh}:${mi}`;
}

function addMinutes(dateObj, minutes) {
  const d = new Date(dateObj.getTime());
  d.setMinutes(d.getMinutes() + minutes);
  return formatDate(d);
}

// =========================
// RANDOM DATE 1-15 (FIXED PER LOAD)
// =========================
const now = new Date();
function randomDate1to15() {
  const year = now.getFullYear();
  const month = now.getMonth();
  const day = 1 + Math.floor(Math.random() * 15);
  const hour = Math.floor(Math.random() * 24);
  const minute = Math.floor(Math.random() * 60);
  return new Date(year, month, day, hour, minute, 0);
}

// =========================
// SEED DATA (100 PARCELS)
// =========================
parcels.length = 0;

for (let i = 0; i < 100; i++) {
  const baseDate = randomDate1to15();
  const baseTime = formatDate(baseDate);

  const senderName = '‡∏ô‡∏≤‡∏¢' + thaiFirstNames[i % thaiFirstNames.length] + ' ' + thaiLastNames[i % thaiLastNames.length];
  const addrPick = thaiAddressMap[i % thaiAddressMap.length];
  const street = thaiStreets[i % thaiStreets.length];
  const address = `‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà ${i + 1} ‡∏ñ‡∏ô‡∏ô${street} ‡∏≠.${addrPick.dist} ‡∏à.${addrPick.prov} ${addrPick.zip}`;

  const events = [
    { point: '‡∏£‡∏±‡∏ö‡∏à‡∏≤‡∏Å‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á Kiosk', by: '‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà Kiosk ' + ((i % 4) + 1), phone: '08' + String(10000000 + i).padStart(8, '0'), time: baseTime },
    { point: '‡∏Ñ‡∏±‡∏î‡πÅ‡∏¢‡∏Å‡∏Ñ‡∏•‡∏±‡∏á', by: '‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ñ‡∏•‡∏±‡∏á ' + ((i % 3) + 1), phone: '08' + String(20000000 + i).padStart(8, '0'), time: addMinutes(baseDate, 45) },
    { point: '‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å', by: '‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏Ç‡∏ô‡∏™‡πà‡∏á ' + ((i % 2) + 1), phone: '08' + String(30000000 + i).padStart(8, '0'), time: addMinutes(baseDate, 120) }
  ];

  parcels.push({
    track: 'SKY' + (240001 + i),
    sentAt: baseTime,
    aot: AOTS[i % AOTS.length],
    sender: senderName,
    address: address,
    senderPhone: '08' + String(40000000 + i).padStart(8, '0'),
    weight: 300 + (i * 7) % 700,
    status: i % 2 === 0 ? '‡∏≠‡∏¢‡∏π‡πà‡∏Ñ‡∏•‡∏±‡∏á' : '‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß',
    events
  });
}

// =========================
// SORTING
// =========================
function updateSortIcons() {
  ['track','sentAt','aot','sender','address','senderPhone','weight','status'].forEach(k => {
    const el = document.getElementById('s-' + k);
    if (!el) return;
    if (sortState.key === k) {
      el.textContent = sortState.asc ? ' ‚ñ≤' : ' ‚ñº';
    } else {
      el.textContent = '';
    }
  });
}

function sortBy(key) {
  if (key === 'sentAt') {
    sortState.key = key;
    sortState.asc = false; // newest first
    _initialSortDone = true;
  } else if (!_initialSortDone) {
    sortState.key = key;
    sortState.asc = true;
    _initialSortDone = true;
  } else if (sortState.key === key) {
    sortState.asc = !sortState.asc;
  } else {
    sortState.key = key;
    sortState.asc = true;
  }

  parcels.sort((a, b) => {
    let va = a[key];
    let vb = b[key];

    if (key === 'sentAt') {
      va = parseDate(va);
      vb = parseDate(vb);
      const dA = new Date(va.getFullYear(), va.getMonth(), va.getDate());
      const dB = new Date(vb.getFullYear(), vb.getMonth(), vb.getDate());
      if (dA.getTime() !== dB.getTime()) {
        return sortState.asc ? dA - dB : dB - dA;
      }
      return sortState.asc ? va - vb : vb - va;
    }

    if (typeof va === 'number') {
      return sortState.asc ? va - vb : vb - va;
    }

    return sortState.asc
      ? String(va).localeCompare(String(vb))
      : String(vb).localeCompare(String(va));
  });

  updateSortIcons();
  render();
}

// =========================
// RENDERING
// =========================
function render() {
  const tb = document.getElementById('parcelTable');
  tb.innerHTML = '';
  let sin = 0, sout = 0;

  parcels.forEach(p => {
    if (filter(p)) {
      tb.innerHTML += `
        <tr>
          <td>${p.track}</td>
          <td>${p.sentAt}</td>
          <td><span class="badge aot">${p.aot}</span></td>
          <td>${p.sender}</td>
          <td>${p.address}</td>
          <td>${p.senderPhone}</td>
          <td>${p.weight} g</td>
          <td><span class="badge ${p.status === '‡∏≠‡∏¢‡∏π‡πà‡∏Ñ‡∏•‡∏±‡∏á' ? 'status-in' : 'status-out'}">${p.status}</span></td>
          <td><button onclick="showTimeline('${p.track}')">‡∏î‡∏π Flow</button></td>
        </tr>
      `;
    }
    p.status === '‡∏≠‡∏¢‡∏π‡πà‡∏Ñ‡∏•‡∏±‡∏á' ? sin++ : sout++;
  });

  document.getElementById('sumAll').innerText = parcels.length;
  document.getElementById('sumIn').innerText = sin;
  document.getElementById('sumOut').innerText = sout;
}

function filter(p) {
  const fd = document.getElementById('filterDate').value;
  const q = document.getElementById('searchInput').value.toLowerCase();
  const fa = document.getElementById('filterAOT').value;
  const fs = document.getElementById('filterStatus').value;
  const matchDate = !fd || p.sentAt.startsWith(fd.split('-').reverse().join('/'));
  return matchDate && (!q || (p.track + p.sender + p.address + p.senderPhone).toLowerCase().includes(q)) &&
         (!fa || p.aot === fa) &&
         (!fs || p.status === fs);
}

['searchInput','filterAOT','filterStatus','filterDate'].forEach(id => {
  document.getElementById(id).oninput = render;
});

function refreshPage() {
  document.getElementById('filterDate').value = '';
  document.getElementById('searchInput').value = '';
  document.getElementById('filterAOT').value = '';
  document.getElementById('filterStatus').value = '';
  sortState = { key: 'sentAt', asc: false };
  _initialSortDone = false;
  sortBy('sentAt');
}

// =========================
// FLOW DIALOG
// =========================
function showTimeline(track) {
  const p = parcels.find(x => x.track === track);
  let html = '<h3>üì¶ Flow Diagram : ' + track + '</h3>';

  p.events.forEach((e, i) => {
    html += `
      <p>
        üîπ <strong>${i + 1}. ${e.point}</strong><br>
        üë§ ${e.by}<br>
        üìû ${e.phone}<br>
        ‚è∞ ${e.time}
      </p>
    `;
    if (i < p.events.length - 1) {
      html += '<p style="text-align:center">‚¨áÔ∏è</p>';
    }
  });

  html += '<button onclick="document.getElementById(\'timelineDialog\').close()">‡∏õ‡∏¥‡∏î</button>';
  const dialog = document.getElementById('timelineDialog');
  dialog.innerHTML = html;
  dialog.showModal();
}

// =========================
// BASIC TESTS (Console)
// =========================
(function runTests(){
  console.assert(typeof addMinutes === 'function', 'addMinutes should be defined');
  const d = new Date(2025,0,1,10,0);
  const s = addMinutes(d, 60);
  console.assert(typeof s === 'string' && s.includes('11:00'), 'addMinutes should add 60 minutes');
  console.assert(parcels.length === 100, 'Should seed exactly 100 parcels');
})();

// Initial load
updateSortIcons();
sortBy('sentAt');
</script>
</body>
</html>
